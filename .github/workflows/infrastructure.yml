name: Deploy Infrastructure (AWS Academy)

on:
  workflow_dispatch:
    inputs:
      expediente:
        description: 'Tu nÃºmero de expediente (ej: A01234567)'
        required: true
        type: string

env:
  AWS_REGION: us-east-1

jobs:
  build-docker-images:
    name: ðŸ³ Build Docker Images
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Build imagen Docker - CatÃ¡logos
        run: |
          echo "ðŸ³ Construyendo imagen Docker para modulo-catalogos..."
          docker build -t notas-venta-catalogos:latest modulo-catalogos/
          echo "âœ… Imagen construida exitosamente"
          docker images | grep notas-venta-catalogos

      - name: Build imagen Docker - Notas
        run: |
          echo "ðŸ³ Construyendo imagen Docker para modulo-notas..."
          docker build -t notas-venta-notas:latest modulo-notas/
          echo "âœ… Imagen construida exitosamente"
          docker images | grep notas-venta-notas

      - name: Build imagen Docker - Notificaciones
        run: |
          echo "ðŸ³ Construyendo imagen Docker para modulo-notificaciones..."
          docker build -t notas-venta-notificaciones:latest modulo-notificaciones/
          echo "âœ… Imagen construida exitosamente"
          docker images | grep notas-venta-notificaciones

      - name: Resumen de imÃ¡genes construidas
        run: |
          echo "## ðŸ³ ImÃ¡genes Docker Construidas" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Imagen | Tag | TamaÃ±o |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----|--------|" >> $GITHUB_STEP_SUMMARY
          docker images --format "| {{.Repository}} | {{.Tag}} | {{.Size}} |" | grep notas-venta >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Nota AWS Academy**: Las imÃ¡genes se construyen pero no se suben a ECR debido a restricciones del Learner Lab." >> $GITHUB_STEP_SUMMARY

  deploy-infrastructure:
    name: ðŸš€ Deploy to AWS Lambda
    needs: build-docker-images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Configurar AWS Credentials (Academy)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Empaquetar Lambda - CatÃ¡logos
        run: |
          echo "ðŸ“¦ Empaquetando modulo-catalogos..."
          cd modulo-catalogos
          pip install -r requirements.txt -t package/ --quiet
          cp -r src/* package/
          cd package && zip -r ../../catalogos-lambda.zip . -q
          cd ../..
          echo "âœ… catalogos-lambda.zip creado ($(du -h catalogos-lambda.zip | cut -f1))"

      - name: Empaquetar Lambda - Notas
        run: |
          echo "ðŸ“¦ Empaquetando modulo-notas..."
          cd modulo-notas
          pip install -r requirements.txt -t package/ --quiet
          cp -r src/* package/
          cd package && zip -r ../../notas-lambda.zip . -q
          cd ../..
          echo "âœ… notas-lambda.zip creado ($(du -h notas-lambda.zip | cut -f1))"

      - name: Empaquetar Lambda - Notificaciones
        run: |
          echo "ðŸ“¦ Empaquetando modulo-notificaciones..."
          cd modulo-notificaciones
          pip install -r requirements.txt -t package/ --quiet
          cp -r src/* package/
          cd package && zip -r ../../notificaciones-lambda.zip . -q
          cd ../..
          echo "âœ… notificaciones-lambda.zip creado ($(du -h notificaciones-lambda.zip | cut -f1))"

      - name: Crear bucket S3 para cÃ³digo y subir cÃ³digo
        run: |
          BUCKET_NAME="${{ github.event.inputs.expediente }}-lambda-code"
          
          # Crear el bucket (con manejo de error mejorado)
          echo "ðŸ“¦ Creando bucket S3: s3://$BUCKET_NAME"
          if aws s3 ls s3://$BUCKET_NAME 2>/dev/null; then
            echo "âœ… Bucket ya existe"
          else
            echo "ðŸ†• Creando nuevo bucket..."
            aws s3 mb s3://$BUCKET_NAME --region ${{ env.AWS_REGION }}
            echo "âœ… Bucket creado exitosamente"
          fi
          
          # Verificar acceso al bucket
          echo ""
          echo "ðŸ” Verificando permisos del bucket..."
          if aws s3 ls s3://$BUCKET_NAME --max-items 1 2>&1 | grep -q "NoSuchBucket\|AccessDenied"; then
            echo "âŒ ERROR: Problema con el bucket"
            aws s3 ls s3://$BUCKET_NAME --max-items 1 2>&1
            echo ""
            echo "ðŸ“‹ Diagnostico:"
            echo "  - Region: ${{ env.AWS_REGION }}"
            echo "  - Bucket: $BUCKET_NAME"
            echo "  - Expediente: ${{ github.event.inputs.expediente }}"
            exit 1
          fi
          echo "âœ… Acceso confirmado"
          
          # Subir cÃ³digo a S3
          echo ""
          echo "â˜ï¸ Subiendo cÃ³digo a S3..."
          aws s3 cp catalogos-lambda.zip s3://$BUCKET_NAME/catalogos-lambda.zip
          echo "âœ… catalogos-lambda.zip subido"
          
          aws s3 cp notas-lambda.zip s3://$BUCKET_NAME/notas-lambda.zip
          echo "âœ… notas-lambda.zip subido"
          
          aws s3 cp notificaciones-lambda.zip s3://$BUCKET_NAME/notificaciones-lambda.zip
          echo "âœ… notificaciones-lambda.zip subido"
          
          echo ""
          echo "âœ… CÃ³digo subido exitosamente a s3://$BUCKET_NAME/"
          
          # Guardar nombre del bucket para pasos siguientes
          echo "BUCKET_NAME=$BUCKET_NAME" >> $GITHUB_ENV

      - name: Deploy CloudFormation Stack
        run: |
          echo "ðŸš€ Desplegando infraestructura..."
          BUCKET_NAME="${{ github.event.inputs.expediente }}-lambda-code"
          aws cloudformation deploy \
            --template-file infrastructure/template-academy.yaml \
            --stack-name notas-venta-stack \
            --parameter-overrides \
              Environment=production \
              Expediente=${{ github.event.inputs.expediente }} \
              CodeBucket=$BUCKET_NAME \
            --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset
          echo "âœ… Stack desplegado exitosamente"

      - name: Obtener y mostrar Outputs
        run: |
          echo "## ðŸš€ Despliegue Completado!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name notas-venta-stack \
            --query "Stacks[0].Outputs[?OutputKey=='ApiUrl'].OutputValue" \
            --output text)
          
          DASHBOARD_URL=$(aws cloudformation describe-stacks \
            --stack-name notas-venta-stack \
            --query "Stacks[0].Outputs[?OutputKey=='DashboardUrl'].OutputValue" \
            --output text)
          
          echo "### ðŸŒ API URL" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "$API_URL" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“Š Endpoints Disponibles" >> $GITHUB_STEP_SUMMARY
          echo "| MÃ©todo | Endpoint | DescripciÃ³n |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| GET | ${API_URL}catalogos/health | Health check catÃ¡logos |" >> $GITHUB_STEP_SUMMARY
          echo "| GET | ${API_URL}notas/health | Health check notas |" >> $GITHUB_STEP_SUMMARY
          echo "| POST | ${API_URL}catalogos/clientes | Crear cliente |" >> $GITHUB_STEP_SUMMARY
          echo "| GET | ${API_URL}catalogos/clientes | Listar clientes |" >> $GITHUB_STEP_SUMMARY
          echo "| POST | ${API_URL}catalogos/productos | Crear producto |" >> $GITHUB_STEP_SUMMARY
          echo "| POST | ${API_URL}notas | Crear nota de venta |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“ˆ Dashboard CloudWatch" >> $GITHUB_STEP_SUMMARY
          echo "[Ver Dashboard]($DASHBOARD_URL)" >> $GITHUB_STEP_SUMMARY
