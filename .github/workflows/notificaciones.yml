name: CI/CD MÃ³dulo Notificaciones

on:
  push:
    branches: [main]
    paths:
      - 'modulo-notificaciones/**'
      - '.github/workflows/notificaciones.yml'
  pull_request:
    branches: [main]
    paths:
      - 'modulo-notificaciones/**'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  MODULE_NAME: notificaciones
  FUNCTION_NAME: production-notificaciones

jobs:
  test:
    name: ðŸ§ª Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: modulo-notificaciones

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: modulo-notificaciones/requirements.txt

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Ejecutar tests
        run: |
          pytest tests/ -v --cov=src --cov-report=term-missing || true
        env:
          ENVIRONMENT: local
          AWS_DEFAULT_REGION: us-east-1

  build-docker:
    name: ðŸ³ Build Docker Image
    needs: [test]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Build imagen Docker
        run: |
          echo "ðŸ³ Construyendo imagen Docker para modulo-notificaciones..."
          docker build -t notas-venta-notificaciones:${{ github.sha }} modulo-notificaciones/
          docker tag notas-venta-notificaciones:${{ github.sha }} notas-venta-notificaciones:latest
          echo "âœ… Imagen construida exitosamente"

      - name: Mostrar informaciÃ³n de imagen
        run: |
          docker images notas-venta-notificaciones
          echo "## ðŸ³ Imagen Docker Construida" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Imagen:** notas-venta-notificaciones" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **TamaÃ±o:** $(docker images notas-venta-notificaciones:latest --format '{{.Size}}')" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: ðŸš€ Deploy to AWS Lambda
    needs: [build-docker]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Configurar AWS Credentials (Academy)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Empaquetar cÃ³digo para Lambda
        run: |
          cd modulo-notificaciones
          pip install -r requirements.txt -t package/ --quiet
          cp -r src/* package/
          cd package && zip -r ../lambda-package.zip . -q
          echo "âœ… Paquete creado: $(du -h ../lambda-package.zip | cut -f1)"

      - name: Subir a S3 y actualizar Lambda
        run: |
          BUCKET_NAME="${{ secrets.EXPEDIENTE }}-lambda-code"
          
          # Subir nuevo cÃ³digo
          aws s3 cp modulo-notificaciones/lambda-package.zip s3://$BUCKET_NAME/notificaciones-lambda.zip
          
          # Actualizar Lambda
          aws lambda update-function-code \
            --function-name ${{ env.FUNCTION_NAME }} \
            --s3-bucket $BUCKET_NAME \
            --s3-key notificaciones-lambda.zip

      - name: Esperar actualizaciÃ³n
        run: |
          aws lambda wait function-updated --function-name ${{ env.FUNCTION_NAME }}
          echo "âœ… Lambda actualizada exitosamente"
