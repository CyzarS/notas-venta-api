name: CI/CD M√≥dulo Notificaciones

on:
  push:
    branches: [main]
    paths:
      - 'modulo-notificaciones/**'
      - '.github/workflows/notificaciones.yml'
  pull_request:
    branches: [main]
    paths:
      - 'modulo-notificaciones/**'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  MODULE_NAME: notificaciones
  FUNCTION_NAME: production-notificaciones

jobs:
  test:
    name: üß™ Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: modulo-notificaciones

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: modulo-notificaciones/requirements.txt

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Ejecutar tests
        run: |
          pytest tests/ -v --cov=src --cov-report=term-missing || true
        env:
          ENVIRONMENT: local
          AWS_DEFAULT_REGION: us-east-1

  build-docker:
    name: üê≥ Build Docker Image
    needs: [test]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Build imagen Docker
        run: |
          echo "üê≥ Construyendo imagen Docker para modulo-notificaciones..."
          docker build -t notas-venta-notificaciones:${{ github.sha }} modulo-notificaciones/
          docker tag notas-venta-notificaciones:${{ github.sha }} notas-venta-notificaciones:latest
          echo "‚úÖ Imagen construida exitosamente"

      - name: Mostrar informaci√≥n de imagen
        run: |
          docker images notas-venta-notificaciones
          echo "## üê≥ Imagen Docker Construida" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Imagen:** notas-venta-notificaciones" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tama√±o:** $(docker images notas-venta-notificaciones:latest --format '{{.Size}}')" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: üöÄ Deploy to AWS Lambda
    needs: [build-docker]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Configurar AWS Credentials (Academy)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Empaquetar c√≥digo para Lambda
        run: |
          cd modulo-notificaciones
          pip install -r requirements.txt -t package/ --quiet
          cp -r src/* package/
          cd package && zip -r ../lambda-package.zip . -q
          echo "‚úÖ Paquete creado: $(du -h ../lambda-package.zip | cut -f1)"

      - name: Subir a S3 y actualizar Lambda
        run: |
          BUCKET_NAME="${{ secrets.EXPEDIENTE }}-lambda-code"
          
          # Verificar que el bucket existe
          if ! aws s3 ls s3://$BUCKET_NAME 2>/dev/null; then
            echo "‚ùå Error: El bucket $BUCKET_NAME no existe."
            echo ""
            echo "Aseg√∫rate de:"
            echo "1. Ejecutar primero el workflow 'Deploy Infrastructure (AWS Academy)'"
            echo "2. Usar el MISMO valor de expediente en ambos workflows"
            echo "3. Verificar que secrets.EXPEDIENTE sea correcto"
            exit 1
          fi
          
          # Subir nuevo c√≥digo
          echo "‚òÅÔ∏è Subiendo c√≥digo a S3..."
          aws s3 cp modulo-notificaciones/lambda-package.zip s3://$BUCKET_NAME/notificaciones-lambda.zip
          echo "‚úÖ C√≥digo subido a s3://$BUCKET_NAME/notificaciones-lambda.zip"
          
          # Actualizar Lambda
          echo "üöÄ Actualizando funci√≥n Lambda..."
          aws lambda update-function-code \
            --function-name ${{ env.FUNCTION_NAME }} \
            --s3-bucket $BUCKET_NAME \
            --s3-key notificaciones-lambda.zip
          echo "‚úÖ Funci√≥n Lambda actualizada"

      - name: Esperar actualizaci√≥n
        run: |
          aws lambda wait function-updated --function-name ${{ env.FUNCTION_NAME }}
          echo "‚úÖ Lambda actualizada exitosamente"
